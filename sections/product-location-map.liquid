{% unless product.gift_card? %}
  {{ 'product-location-map.css' | asset_url | stylesheet_tag }}

  <div class="product-location-map page-width">
    {% if product.metafields.custom.address %}
      <div id="map" style="width: 100%; height: 400px; margin-top: 1rem;"></div>

      <script>
  function initMap() {
    var address = "{{ product.metafields.custom.address | escape }}";
    var productName = "{{ product.title | escape }}";

    if (address) {
      var geocoder = new google.maps.Geocoder();
      geocoder.geocode({ 'address': address }, function(results, status) {
        if (status === 'OK') {
          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: results[0].geometry.location
          });

          var marker = new google.maps.Marker({
            position: results[0].geometry.location,
            map: map
          });

          var infoWindow = new google.maps.InfoWindow({
            content: `
              <div id="info-hook">
                <div class="custom-infowindow">
                  <strong>${productName}</strong><br>
                  <small>${address}</small>
                </div>
              </div>
            `
          });

          marker.addListener('click', function() {
            infoWindow.open(map, marker);
          });

         google.maps.event.addListener(infoWindow, 'domready', function () {
  // Shrink close button
  const closeBtn = $('.gm-style-iw button.gm-ui-hover-effect');
  const closeIcon = closeBtn.find('span');

  // Override hardcoded span style directly
  closeIcon.attr('style', `
    mask-image: url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20d%3D%22M19%206.41L17.59%205%2012%2010.59%206.41%205%205%206.41%2010.59%2012%205%2017.59%206.41%2019%2012%2013.41%2017.59%2019%2019%2017.59%2013.41%2012z%22/%3E%3Cpath%20d%3D%22M0%200h24v24H0z%22%20fill%3D%22none%22/%3E%3C/svg%3E");
    pointer-events: none;
    display: block;
    width: 5px;
    height: 5px;
    margin: 4px;
    mask-size: 5px 5px;
    -webkit-mask-size: 5px 5px;
  `);

  // Also shrink the <button> itself
  closeBtn.css({
    width: '5px',
    height: '5px',
    top: '4px',
    right: '4px'
  });
});


        } else {
          console.error('Geocode failed: ' + status);
        }
      });
    }
  }
      </script>

      <script
        async
        defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ3bPzVGn7UbU6BBDYHX6mB4xjb6tAR5o&callback=initMap"
      ></script>
    {% endif %}
  </div>
{% endunless %}
