{% doc %}
  @prompt
    A magazine-style editorial layout that uses my shopify blog posts.
    Requirements:
    - Hide the author
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-magazine-layout-{{ ai_gen_id }} {
    max-width: 1200px;
    margin: 0 auto;
    padding: {{ block.settings.section_padding }}px;
    background-color: {{ block.settings.background_color }};
  }

  .ai-magazine-header-{{ ai_gen_id }} {
    text-align: center;
    margin-bottom: 40px;
  }

  .ai-magazine-title-{{ ai_gen_id }} {
    font-size: {{ block.settings.title_size }}px;
    color: {{ block.settings.text_color }};
    margin: 0 0 16px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .ai-magazine-subtitle-{{ ai_gen_id }} {
    font-size: {{ block.settings.subtitle_size }}px;
    color: {{ block.settings.text_color }};
    opacity: 0.7;
    margin: 0;
    font-weight: 400;
  }

  /* ===== Hero + sidebar ===== */
  .ai-magazine-grid-{{ ai_gen_id }} {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 32px;
    margin-bottom: 48px;
  }

  .ai-magazine-featured-{{ ai_gen_id }} { position: relative; }

  .ai-magazine-featured-image-{{ ai_gen_id }} {
    width: 100%;
    aspect-ratio: 16/10;
    object-fit: cover;
    border-radius: {{ block.settings.image_border_radius }}px;
  }

  .ai-magazine-featured-placeholder-{{ ai_gen_id }} {
    width: 100%;
    aspect-ratio: 16/10;
    background-color: #f4f4f4;
    border-radius: {{ block.settings.image_border_radius }}px;
    display: flex; align-items: center; justify-content: center;
  }
  .ai-magazine-featured-placeholder-{{ ai_gen_id }} svg { width: 60%; height: 60%; opacity: .3; }

  .ai-magazine-featured-content-{{ ai_gen_id }} {
    position: absolute; inset-inline: 0; bottom: 0;
    background: linear-gradient(transparent, rgba(0,0,0,.8));
    padding: 40px 24px 24px;
    border-radius: 0 0 {{ block.settings.image_border_radius }}px {{ block.settings.image_border_radius }}px;
  }

  .ai-magazine-featured-category-{{ ai_gen_id }} {
    display: inline-block;
    background-color: {{ block.settings.accent_color }};
    color: #fff;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px;
    margin-bottom: 12px;
  }
  .ai-magazine-featured-title-{{ ai_gen_id }} { color: #fff; font-size: 28px; font-weight: 700; margin: 0 0 8px; line-height: 1.2; }
  .ai-magazine-featured-excerpt-{{ ai_gen_id }} { color: rgba(255,255,255,.9); font-size: 16px; line-height: 1.5; margin: 0 0 12px; }
  .ai-magazine-featured-meta-{{ ai_gen_id }} { color: rgba(255,255,255,.7); font-size: 14px; }

  .ai-magazine-sidebar-{{ ai_gen_id }} { display: flex; flex-direction: column; gap: 24px; }
  .ai-magazine-sidebar-article-{{ ai_gen_id }} { display: flex; gap: 16px; padding-bottom: 24px; border-bottom: 1px solid rgba(0,0,0,.1); }
  .ai-magazine-sidebar-article-{{ ai_gen_id }}:last-child { border-bottom: none; padding-bottom: 0; }

  .ai-magazine-sidebar-image-{{ ai_gen_id }},
  .ai-magazine-sidebar-placeholder-{{ ai_gen_id }} {
    width: 80px; height: 80px; flex-shrink: 0; border-radius: {{ block.settings.image_border_radius }}px; object-fit: cover;
    display: flex; align-items: center; justify-content: center; background-color: #f4f4f4;
  }
  .ai-magazine-sidebar-placeholder-{{ ai_gen_id }} svg { width: 50%; height: 50%; opacity: .3; }

  .ai-magazine-sidebar-content-{{ ai_gen_id }} { flex: 1; }
  .ai-magazine-sidebar-category-{{ ai_gen_id }} { color: {{ block.settings.accent_color }}; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; }
  .ai-magazine-sidebar-title-{{ ai_gen_id }} { color: {{ block.settings.text_color }}; font-size: 16px; font-weight: 600; margin: 0 0 8px; line-height: 1.3; }
  .ai-magazine-sidebar-meta-{{ ai_gen_id }} { color: {{ block.settings.text_color }}; opacity: .6; font-size: 12px; }

  /* ===== Cards (shared) ===== */
  .ai-magazine-card-{{ ai_gen_id }} {
    background-color: #fff;
    border-radius: {{ block.settings.card_border_radius }}px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,.1);
    transition: transform .3s ease, box-shadow .3s ease;
    scroll-snap-align: start;
  }
  .ai-magazine-card-{{ ai_gen_id }}:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,.15); }
  .ai-magazine-card--big-{{ ai_gen_id }} .ai-magazine-card-title-{{ ai_gen_id }} { font-size: 22px; }
  .ai-magazine-card--big-{{ ai_gen_id }} .ai-magazine-card-excerpt-{{ ai_gen_id }} { font-size: 15px; }

  .ai-magazine-card-image-{{ ai_gen_id }} { width: 100%; aspect-ratio: 16/10; object-fit: cover; }
  .ai-magazine-card-placeholder-{{ ai_gen_id }} { width: 100%; aspect-ratio: 16/10; background: #f4f4f4; display: flex; align-items: center; justify-content: center; }
  .ai-magazine-card-placeholder-{{ ai_gen_id }} svg { width: 50%; height: 50%; opacity: .3; }

  .ai-magazine-card-content-{{ ai_gen_id }} { padding: 24px; }
  .ai-magazine-card-category-{{ ai_gen_id }} { color: {{ block.settings.accent_color }}; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
  .ai-magazine-card-title-{{ ai_gen_id }} { color: {{ block.settings.text_color }}; font-size: 20px; font-weight: 600; margin: 0 0 12px; line-height: 1.3; }
  .ai-magazine-card-excerpt-{{ ai_gen_id }} { color: {{ block.settings.text_color }}; opacity: .7; font-size: 14px; line-height: 1.5; margin: 0 0 16px; }
  .ai-magazine-card-meta-{{ ai_gen_id }} { color: {{ block.settings.text_color }}; opacity: .6; font-size: 12px; }

  .ai-magazine-link-{{ ai_gen_id }} { text-decoration: none; color: inherit; display: block; }

  /* ===== Horizontal rows by tag ===== */
  .ai-magazine-groups-{{ ai_gen_id }} { margin-top: 8px; }
  .ai-magazine-group-{{ ai_gen_id }} { margin-bottom: 48px; position: relative; }
  .ai-magazine-group-head-{{ ai_gen_id }} {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .ai-magazine-group-title-{{ ai_gen_id }} {
    color: {{ block.settings.text_color }};
    font-size: 22px; font-weight: 800; margin: 0; letter-spacing: -0.01em;
  }

  /* Scrollable track */
  .ai-magazine-row-track-{{ ai_gen_id }} {
    --card-width: 420px;
    display: flex;
    gap: 24px;
    overflow-x: auto;
    overscroll-behavior-x: contain;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    padding-bottom: 10px;
    scroll-behavior: smooth;
    touch-action: pan-x;
  }
  .ai-magazine-row-track-{{ ai_gen_id }}::-webkit-scrollbar { height: 8px; }
  .ai-magazine-row-track-{{ ai_gen_id }}::-webkit-scrollbar-thumb { background: rgba(0,0,0,.2); border-radius: 4px; }
  .ai-magazine-row-track-{{ ai_gen_id }}::-webkit-scrollbar-track { background: transparent; }

  /* Fixed-width slides */
  .ai-magazine-row-track-{{ ai_gen_id }} .ai-magazine-card-{{ ai_gen_id }} {
    flex: 0 0 var(--card-width);
    min-width: var(--card-width);
  }

  /* Row controls */
  .ai-magazine-row-controls-{{ ai_gen_id }} { display: flex; gap: 8px; }
  .ai-magazine-row-btn-{{ ai_gen_id }} {
    border: 1px solid rgba(0,0,0,.12);
    background: #fff;
    cursor: pointer;
    border-radius: 999px;
    width: 36px; height: 36px;
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 18px; line-height: 1;
    transition: transform .15s ease, background .2s ease, box-shadow .2s ease;
  }
  .ai-magazine-row-btn-{{ ai_gen_id }}:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.08); }
  .ai-magazine-row-btn-{{ ai_gen_id }}:disabled { opacity: .35; cursor: default; }

  .ai-magazine-empty-state-{{ ai_gen_id }} { text-align: center; padding: 60px 20px; color: {{ block.settings.text_color }}; opacity: .6; }
  .ai-magazine-empty-state-{{ ai_gen_id }} h3 { margin: 0 0 8px; font-size: 18px; }
  .ai-magazine-empty-state-{{ ai_gen_id }} p { margin: 0; font-size: 14px; }

  @media (max-width: 768px) {
    .ai-magazine-grid-{{ ai_gen_id }} { grid-template-columns: 1fr; gap: 24px; }
    .ai-magazine-featured-content-{{ ai_gen_id }} { padding: 24px 16px 16px; }
    .ai-magazine-featured-title-{{ ai_gen_id }} { font-size: 22px; }
    .ai-magazine-sidebar-{{ ai_gen_id }} { display: none !important; }
    .ai-magazine-card-content-{{ ai_gen_id }} { padding: 16px; }

    /* Wider slides on mobile for a “card carousel” feel */
    .ai-magazine-row-track-{{ ai_gen_id }} { --card-width: 80vw; gap: 16px; }
    .ai-magazine-row-controls-{{ ai_gen_id }} { display: none; } /* swipe on mobile */
  }
{% endstyle %}

<div class="ai-magazine-layout-{{ ai_gen_id }}" {{ block.shopify_attributes }}>
  {% assign group_tags = 'Eventi|Inspo|Milano|Travel' | split: '|' %}

  {% if block.settings.title != blank or block.settings.subtitle != blank %}
    <div class="ai-magazine-header-{{ ai_gen_id }}">
      {% if block.settings.title != blank %}
        <h2 class="ai-magazine-title-{{ ai_gen_id }}">{{ block.settings.title }}</h2>
      {% endif %}
      {% if block.settings.subtitle != blank %}
        <p class="ai-magazine-subtitle-{{ ai_gen_id }}">{{ block.settings.subtitle }}</p>
      {% endif %}
    </div>
  {% endif %}

  {% if block.settings.blog != blank %}
    {% assign articles = block.settings.blog.articles | limit: block.settings.articles_count %}

    {% if articles.size > 0 %}
      <!-- ===== Featured + most recent sidebar ===== -->
      <div class="ai-magazine-grid-{{ ai_gen_id }}">
        {% assign featured_article = articles.first %}
        <div class="ai-magazine-featured-{{ ai_gen_id }}">
          <a href="{{ featured_article.url }}" class="ai-magazine-link-{{ ai_gen_id }}">
            {% if featured_article.image %}
              <img
                src="{{ featured_article.image | image_url: width: 800 }}"
                alt="{{ featured_article.image.alt | escape }}"
                class="ai-magazine-featured-image-{{ ai_gen_id }}"
                loading="lazy"
                width="800"
                height="500">
            {% else %}
              <div class="ai-magazine-featured-placeholder-{{ ai_gen_id }}">
                {{ 'image' | placeholder_svg_tag }}
              </div>
            {% endif %}

            <div class="ai-magazine-featured-content-{{ ai_gen_id }}">
              {% if featured_article.tags.size > 0 %}
                <span class="ai-magazine-featured-category-{{ ai_gen_id }}">{{ featured_article.tags.first }}</span>
              {% endif %}
              <h3 class="ai-magazine-featured-title-{{ ai_gen_id }}">{{ featured_article.title }}</h3>
              {% if featured_article.excerpt != blank %}
                <p class="ai-magazine-featured-excerpt-{{ ai_gen_id }}">{{ featured_article.excerpt | strip_html | truncate: 120 }}</p>
              {% endif %}
              <div class="ai-magazine-featured-meta-{{ ai_gen_id }}">{{ featured_article.published_at | date: '%B %d, %Y' }}</div>
            </div>
          </a>
        </div>

        {% if articles.size > 1 %}
          <div class="ai-magazine-sidebar-{{ ai_gen_id }}">
            {% for article in articles offset: 1 limit: 4 %}
              <div class="ai-magazine-sidebar-article-{{ ai_gen_id }}">
                <a href="{{ article.url }}" class="ai-magazine-link-{{ ai_gen_id }}">
                  {% if article.image %}
                    <img
                      src="{{ article.image | image_url: width: 160 }}"
                      alt="{{ article.image.alt | escape }}"
                      class="ai-magazine-sidebar-image-{{ ai_gen_id }}"
                      loading="lazy"
                      width="80"
                      height="80">
                  {% else %}
                    <div class="ai-magazine-sidebar-placeholder-{{ ai_gen_id }}">
                      {{ 'image' | placeholder_svg_tag }}
                    </div>
                  {% endif %}
                </a>
                <div class="ai-magazine-sidebar-content-{{ ai_gen_id }}">
                  {% if article.tags.size > 0 %}
                    <div class="ai-magazine-sidebar-category-{{ ai_gen_id }}">{{ article.tags.first }}</div>
                  {% endif %}
                  <a href="{{ article.url }}" class="ai-magazine-link-{{ ai_gen_id }}">
                    <h4 class="ai-magazine-sidebar-title-{{ ai_gen_id }}">{{ article.title }}</h4>
                  </a>
                  <div class="ai-magazine-sidebar-meta-{{ ai_gen_id }}">{{ article.published_at | date: '%B %d, %Y' }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- ===== Horizontal grouped rows by tag (duplicates allowed, fixed matching) ===== -->
      <div class="ai-magazine-groups-{{ ai_gen_id }}">
        {% for tag in group_tags %}
          {% assign row_dom_id = 'row-' | append: ai_gen_id | append: '-' | append: tag | handleize %}
          {% assign tag_handle = tag | handleize %}
          {% assign count_in_group = 0 %}

          {% capture row_html %}
            <div class="ai-magazine-group-{{ ai_gen_id }}">
              <div class="ai-magazine-group-head-{{ ai_gen_id }}">
                <h3 class="ai-magazine-group-title-{{ ai_gen_id }}">{{ tag }}</h3>
                <div class="ai-magazine-row-controls-{{ ai_gen_id }}">
                  <button type="button" class="ai-magazine-row-btn-{{ ai_gen_id }} prev" aria-label="Scroll {{ tag }} left" data-row="{{ row_dom_id }}">&#10094;</button>
                  <button type="button" class="ai-magazine-row-btn-{{ ai_gen_id }} next" aria-label="Scroll {{ tag }} right" data-row="{{ row_dom_id }}">&#10095;</button>
                </div>
              </div>

              <div id="{{ row_dom_id }}" class="ai-magazine-row-track-{{ ai_gen_id }}">
                {% for article in articles %}
                  {% assign matched = '' %}
                  {% for t in article.tags %}
                    {% assign t_handle = t | handleize %}
                    {% if t_handle == tag_handle %}
                      {% assign matched = 'yes' %}
                      {% break %}
                    {% endif %}
                  {% endfor %}

                  {% if matched == 'yes' %}
                    {% assign count_in_group = count_in_group | plus: 1 %}
                    <div class="ai-magazine-card-{{ ai_gen_id }} ai-magazine-card--big-{{ ai_gen_id }}">
                      <a href="{{ article.url }}" class="ai-magazine-link-{{ ai_gen_id }}">
                        {% if article.image %}
                          <img
                            src="{{ article.image | image_url: width: 640 }}"
                            alt="{{ article.image.alt | escape }}"
                            class="ai-magazine-card-image-{{ ai_gen_id }}"
                            loading="lazy"
                            width="640"
                            height="400">
                        {% else %}
                          <div class="ai-magazine-card-placeholder-{{ ai_gen_id }}">
                            {{ 'image' | placeholder_svg_tag }}
                          </div>
                        {% endif %}

                        <div class="ai-magazine-card-content-{{ ai_gen_id }}">
                          <div class="ai-magazine-card-category-{{ ai_gen_id }}">{{ tag }}</div>
                          <h3 class="ai-magazine-card-title-{{ ai_gen_id }}">{{ article.title }}</h3>
                          {% if article.excerpt != blank %}
                            <p class="ai-magazine-card-excerpt-{{ ai_gen_id }}">{{ article.excerpt | strip_html | truncate: 100 }}</p>
                          {% endif %}
                          <div class="ai-magazine-card-meta-{{ ai_gen_id }}">{{ article.published_at | date: '%B %d, %Y' }}</div>
                        </div>
                      </a>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endcapture %}

          {% if count_in_group > 0 %}
            {{ row_html }}
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      <div class="ai-magazine-empty-state-{{ ai_gen_id }}">
        <h3>No articles found</h3>
        <p>Next, publish some blog posts to display them here</p>
      </div>
    {% endif %}
  {% else %}
    <div class="ai-magazine-empty-state-{{ ai_gen_id }}">
      <h3>Select a blog</h3>
      <p>Next, choose a blog to display articles from</p>
    </div>
  {% endif %}
</div>

<script>
/* Lightweight row controls (scoped per instance) */
(function() {
  var thisScript = document.currentScript;
  var container = thisScript && thisScript.previousElementSibling;
  if (!container || !container.classList.contains('ai-magazine-layout-{{ ai_gen_id }}')) {
    container = document.querySelector('.ai-magazine-layout-{{ ai_gen_id }}');
  }
  if (!container) return;

  var rows = container.querySelectorAll('.ai-magazine-row-track-{{ ai_gen_id }}');

  function setDisabled(prevBtn, nextBtn, el) {
    var max = el.scrollWidth - el.clientWidth - 1;
    prevBtn.disabled = el.scrollLeft <= 0;
    nextBtn.disabled = el.scrollLeft >= max;
  }

  rows.forEach(function(el) {
    var group = el.closest('.ai-magazine-group-{{ ai_gen_id }}');
    if (!group) return;
    var prevBtn = group.querySelector('.ai-magazine-row-btn-{{ ai_gen_id }}.prev');
    var nextBtn = group.querySelector('.ai-magazine-row-btn-{{ ai_gen_id }}.next');
    if (!prevBtn || !nextBtn) return;

    function step() { return Math.max(el.clientWidth * 0.9, 320); }

    prevBtn.addEventListener('click', function() { el.scrollBy({ left: -step(), behavior: 'smooth' }); });
    nextBtn.addEventListener('click', function() { el.scrollBy({ left:  step(), behavior: 'smooth' }); });

    el.addEventListener('scroll', function() { setDisabled(prevBtn, nextBtn, el); });
    window.addEventListener('resize', function() { setDisabled(prevBtn, nextBtn, el); });

    setDisabled(prevBtn, nextBtn, el);
  });
})();
</script>

{% schema %}
{
  "name": "Magazine editorial layout",
  "settings": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "title", "label": "Title", "default": "Latest Stories" },
    { "type": "text", "id": "subtitle", "label": "Subtitle", "default": "Discover our latest articles and insights" },
    { "type": "blog", "id": "blog", "label": "Blog" },
    { "type": "range", "id": "articles_count", "min": 3, "max": 50, "step": 1, "label": "Number of articles", "default": 24 },

    { "type": "header", "content": "Layout" },
    { "type": "select", "id": "columns_desktop", "label": "Columns on desktop", "options": [
        { "value": "2", "label": "2" },
        { "value": "3", "label": "3" },
        { "value": "4", "label": "4" }
      ], "default": "3"
    },
    { "type": "select", "id": "columns_mobile", "label": "Columns on mobile", "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ], "default": "1"
    },

    { "type": "range", "id": "section_padding", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Section padding", "default": 40 },

    { "type": "header", "content": "Style" },
    { "type": "color", "id": "background_color", "label": "Background color", "default": "#ffffff" },
    { "type": "color", "id": "text_color", "label": "Text color", "default": "#000000" },
    { "type": "color", "id": "accent_color", "label": "Accent color", "default": "#e74c3c" },
    { "type": "range", "id": "title_size", "min": 20, "max": 60, "step": 2, "unit": "px", "label": "Title size", "default": 36 },
    { "type": "range", "id": "subtitle_size", "min": 14, "max": 24, "step": 1, "unit": "px", "label": "Subtitle size", "default": 18 },
    { "type": "range", "id": "image_border_radius", "min": 0, "max": 20, "step": 2, "unit": "px", "label": "Image border radius", "default": 8 },
    { "type": "range", "id": "card_border_radius", "min": 0, "max": 20, "step": 2, "unit": "px", "label": "Card border radius", "default": 12 }
  ],
  "presets": [
    { "name": "Magazine editorial layout" }
  ]
}
{% endschema %}
