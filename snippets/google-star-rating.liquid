{% comment %}
  Renders Google star rating for a place

  Accepts:
  - product: {Object} Product Liquid object with place_id metafield (optional)
  - place_id: {String} Google Place ID (optional, overrides product metafield)
  - title: {String} Title to display above rating (optional)
  - show_details: {Boolean} Show rating number and review count (optional, default: true)
  - alignment: {String} Text alignment: left, center, right (optional, default: left)
  - star_size: {Number} Size of stars in pixels (optional, default: 20)
  - star_color: {String} Color of filled stars (optional, default: #ffd700)
  - title_color: {String} Color of title text (optional, default: #333)
  - details_color: {String} Color of details text (optional, default: #666)
  - class: {String} Additional CSS classes (optional)

  Usage:
  {% render 'google-star-rating', product: product %}
  {% render 'google-star-rating', place_id: 'ChIJ...', title: 'Customer Rating', alignment: 'center' %}
{% endcomment %}

{%- liquid
  if place_id
    assign rating_place_id = place_id
  elsif product.metafields.custom.place_id
    assign rating_place_id = product.metafields.custom.place_id
  else
    assign rating_place_id = null
  endif

  assign rating_title = title | default: ''
  assign rating_show_details = show_details | default: true
  assign rating_alignment = alignment | default: 'left'
  assign rating_star_size = star_size | default: 20
  assign rating_star_color = star_color | default: '#ffd700'
  assign rating_title_color = title_color | default: '#333333'
  assign rating_details_color = details_color | default: '#666666'
  assign rating_class = class | default: ''

  assign unique_id = 'google-rating-' | append: rating_place_id | replace: ' ', '-' | replace: '/', '-'
-%}

{%- if rating_place_id != blank -%}
<div class="google-star-rating {{ rating_class }}"
     id="{{ unique_id }}"
     data-place-id="{{ rating_place_id }}"
     style="text-align: {{ rating_alignment }};">

  {%- if rating_title != blank -%}
    <div class="google-star-rating__title" style="color: {{ rating_title_color }};">
      {{ rating_title }}
    </div>
  {%- endif -%}

  <div class="google-star-rating__container">
    <div class="google-star-rating__content" style="display: none;">
      <div class="google-star-rating__stars"
           data-star-size="{{ rating_star_size }}"
           data-star-color="{{ rating_star_color }}">
      </div>

      {%- if rating_show_details -%}
        <div class="google-star-rating__details" style="color: {{ rating_details_color }};">
          <span class="rating-value" style="color: {{ rating_title_color }};"></span>
          <span class="rating-text">out of 5 stars</span>
          <span class="rating-count"></span>
        </div>
      {%- endif -%}

      <div class="google-star-rating__logo">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
      </div>
    </div>
  </div>
</div>

<style>
  .google-star-rating {
    display: inline-block;
    margin: 8px 0;
  }

  .google-star-rating__title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    margin-top: 0;
  }

  .google-star-rating__container {
    display: inline-block;
  }

  .google-star-rating__content {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .google-star-rating__stars {
    line-height: 1;
    display: flex;
    align-items: center;
    margin: 0;
  }

  .google-star-rating__stars .star {
    margin-right: 1px;
    line-height: 1;
    display: inline-block;
  }

  .google-star-rating__details {
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 4px;
    margin: 0;
    line-height: 1.2;
  }

  .google-star-rating__details .rating-value {
    font-weight: 600;
  }

  .google-star-rating__details .rating-count {
    font-style: italic;
  }

  .google-star-rating__logo {
    opacity: 0.7;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    margin-top: -1px; /* Fine-tune vertical alignment */
  }

  .google-star-rating__logo svg {
    width: 16px;
    height: 16px;
    display: block;
  }
</style>

<script>
  (function() {
    // Avoid multiple script executions
    if (window.GoogleStarRatingSnippet) return;
    window.GoogleStarRatingSnippet = true;

    class GoogleStarRatingManager {
      constructor() {
        this.processedRatings = new Set();
        this.apiReady = false;
        this.apiPromise = null;
        this.init();
      }

      async init() {
        // Wait for DOM and then process all ratings
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => this.processAllRatings());
        } else {
          this.processAllRatings();
        }
      }

      async processAllRatings() {
        const ratingElements = document.querySelectorAll('.google-star-rating[data-place-id]');

        for (const element of ratingElements) {
          const elementId = element.id;
          if (!this.processedRatings.has(elementId)) {
            this.processedRatings.add(elementId);
            await this.loadRating(element);
          }
        }
      }

      async ensureGoogleMapsAPI() {
        if (this.apiReady) return;

        if (this.apiPromise) {
          await this.apiPromise;
          return;
        }

        this.apiPromise = this.waitForGoogleMaps();
        await this.apiPromise;
        this.apiReady = true;
      }

      async waitForGoogleMaps() {
        let attempts = 0;
        const maxRetries = 15;

        while (attempts < maxRetries) {
          if (typeof google !== 'undefined' && google.maps) {
            try {
              await google.maps.importLibrary("places");
              console.log('âœ… Google Maps API found for star rating snippet');
              return;
            } catch (placesError) {
              console.log(`âš ï¸ Places library not ready for rating: ${placesError.message}`);
            }
          }

          await new Promise(resolve => setTimeout(resolve, 300));
          attempts++;
        }

        // Fallback: load our own API
        console.log('ðŸ”„ Loading Google Maps API for star rating...');
        await this.loadGoogleMapsAPI();
      }

      async loadGoogleMapsAPI() {
        return new Promise((resolve, reject) => {
          if (document.querySelector('script[src*="googleapis.com/maps"]')) {
            const checkGoogle = () => {
              if (typeof google !== 'undefined' && google.maps) {
                resolve();
              } else {
                setTimeout(checkGoogle, 100);
              }
            };
            checkGoogle();
            return;
          }

          const script = document.createElement('script');
          script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCQ3bPzVGn7UbU6BBDYHX6mB4xjb6tAR5o&libraries=places';
          script.async = true;
          script.defer = true;
          script.onload = resolve;
          script.onerror = () => reject(new Error('Failed to load Google Maps API'));
          document.head.appendChild(script);
        });
      }

      async loadRating(element) {
        const placeId = element.dataset.placeId;
        const contentContainer = element.querySelector('.google-star-rating__content');

        try {
          await this.ensureGoogleMapsAPI();

          if (!placeId || placeId.trim() === '') {
            throw new Error('Invalid Place ID');
          }

          const { Place } = await google.maps.importLibrary("places");
          const place = new Place({ id: placeId.trim() });

          await place.fetchFields({
            fields: ['rating', 'userRatingCount']
          });

          if (place.rating !== null && place.rating !== undefined) {
            this.displayRating(element, place.rating, place.userRatingCount || 0);
          } else {
            // Don't display anything if no rating available
            this.hideElement(element);
          }

        } catch (error) {
          console.error('Google star rating error:', error);
          // Don't display anything if there's an error
          this.hideElement(element);
        }
      }

      displayRating(element, rating, reviewsCount) {
        const starsContainer = element.querySelector('.google-star-rating__stars');
        const detailsContainer = element.querySelector('.google-star-rating__details');
        const contentContainer = element.querySelector('.google-star-rating__content');

        if (!starsContainer) return;

        const starSize = starsContainer.dataset.starSize || '20';
        const starColor = starsContainer.dataset.starColor || '#ffd700';

        // Generate stars
        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

        let starsHTML = '';

        for (let i = 0; i < fullStars; i++) {
          starsHTML += `<span class="star filled" style="font-size: ${starSize}px; color: ${starColor};">â˜…</span>`;
        }

        if (hasHalfStar) {
          starsHTML += `<span class="star half" style="font-size: ${starSize}px; color: ${starColor};">â˜†</span>`;
        }

        for (let i = 0; i < emptyStars; i++) {
          starsHTML += `<span class="star empty" style="font-size: ${starSize}px; color: #ddd;">â˜†</span>`;
        }

        starsContainer.innerHTML = starsHTML;

        // Update details
        if (detailsContainer) {
          const ratingValue = detailsContainer.querySelector('.rating-value');
          const ratingCount = detailsContainer.querySelector('.rating-count');

          if (ratingValue) ratingValue.textContent = rating.toFixed(1);
          if (ratingCount) {
            ratingCount.textContent = `(${reviewsCount} review${reviewsCount !== 1 ? 's' : ''})`;
          }
        }

        // Show the content now that it's ready
        if (contentContainer) {
          contentContainer.style.display = 'flex';
        }
      }

      hideElement(element) {
        // Hide the entire rating element if there's an error or no rating
        element.style.display = 'none';
      }
    }

    // Initialize the manager
    new GoogleStarRatingManager();
  })();
</script>
{%- endif -%}